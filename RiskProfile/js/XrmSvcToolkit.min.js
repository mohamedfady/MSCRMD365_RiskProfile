var XrmSvcToolkit=(function(J,m){var s="/XRMServices/2011/OrganizationData.svc",j="/XRMServices/2011/Organization.svc/web";var d=Object.prototype.toString,p=function(Q){return d.call(Q)==="[object Function]"},o=function(Q){return !isNaN(parseInt(Q))},k=function(Q){return d.call(Q)==="[object String]"},w=function(Q){return d.call(Q)==="[object Array]"},K=function(Q){if(!k(Q)||Q.length===0){return false}return/[^\s]+/.test(Q)};var x=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.?(\d*)?(Z|[+-]\d{2}?(:\d{2})?)?$/,F=/^\/Date\(([-+]?\d+)\)\/$/;var P=(function(){if(p(J.GetGlobalContext)){return GetGlobalContext()}else{if(Xrm!=m){return Xrm.Page.context}else{throw new Error("CRM context is not available.")}}})();var q=(function(){try{return P.getClientUrl()}catch(R){var S=J.location.protocol+"//"+J.location.host;if(P.isOutlookClient()&&!P.isOutlookOnline()){return S}else{var Q=P.getServerUrl();Q=Q.replace(/^(http|https):\/\/([_a-zA-Z0-9\-\.]+)(:([0-9]{1,5}))?/,S);Q=Q.replace(/\/$/,"")}return Q}})();var M=function(S){var Q;try{Q=JSON.parse(S.responseText).error.message.value}catch(R){Q=S.responseText}Q=Q.length>0?"Error: "+S.status+": "+S.statusText+": "+Q:"Error: "+S.status+": "+S.statusText;return new Error(Q)};var a=function(R){var Q=R.responseText.length>0?"Error: "+R.status+": "+R.statusText+": "+R.responseText:"Error: "+R.status+": "+R.statusText;return new Error(Q)};var v=function(R,S){if(typeof S==="string"){if(S.match(F)){var Q=S.replace(F,"$1");return new Date(parseInt(Q,10))}}return S};var y=function(R){if(R==null){return null}if(R==""){return""}var T;var Q="";for(var S=0;S<R.length;S++){T=R.charCodeAt(S);if((T>96&&T<123)||(T>64&&T<91)||(T>47&&T<58)||(T==32)||(T==44)||(T==46)||(T==45)||(T==95)){Q=Q+String.fromCharCode(T)}else{Q=Q+"&#"+T+";"}}return Q};var i=function(R){if(R==null||!R.match(x)){return null}var Q=x.exec(R);return new Date(Date.UTC(parseInt(Q[1],10),parseInt(Q[2],10)-1,parseInt(Q[3],10),parseInt(Q[4],10)-(Q[8]==""||Q[8]=="Z"?0:parseInt(Q[8])),parseInt(Q[5],10),parseInt(Q[6],10)))};var B=function(T,S){for(var R=0;R<T.attributes.length;R++){var Q=T.attributes[R];if(Q.name==S){return Q.value}}};var g=function(Q){return Q.text!==m?Q.text:Q.textContent};var t=function(R,Q){switch(R){case"c:string":case"c:guid":return g(Q);case"c:boolean":return g(Q)==="true";case"c:int":return parseInt(g(Q));case"c:decimal":case"c:double":return parseFloat(g(Q));case"c:dateTime":return i(g(Q));case"a:OptionSetValue":Q=u(Q,"a:Value");return{Value:parseInt(g(Q))};case"a:Money":Q=u(Q,"a:Value");return{Value:g(Q)};case"a:EntityReference":return D(Q);case"a:EntityCollection":return n(Q);case"a:AliasedValue":Q=u(Q,"a:Value");R=B(Q,"i:type");return t(R,Q);default:throw new Error('Unhandled field type: "'+R+'", please report the problem to the developer. ')}};var c=function(Q,R){if(w(Q)&&Q.length>0){return Q.join(",")}else{if(k(Q)){return Q}else{if(R!=m){throw new Error(R+" parameter must be either a delimited string or an array. ")}else{return""}}}};var n=function(ai){var ab,ak,ae,T,aj;for(var ad=0;ad<ai.childNodes.length;ad++){var V=ai.childNodes[ad];switch(V.nodeName){case"a:EntityName":ab=g(V);break;case"a:MoreRecords":ak=g(V)==="true";break;case"a:PagingCookie":ae=g(V);break;case"a:TotalRecordCount":T=parseInt(g(V));break;case"a:Entities":aj=V;break}}var Z={entityName:ab,moreRecords:ak,pagingCookie:ae,totalRecordCount:T,entities:[]};for(var ah=0;ah<aj.childNodes.length;ah++){var aa={formattedValues:[]};var S=aj.childNodes[ah];var Y=u(S,"a:Attributes");for(var ag=0;ag<Y.childNodes.length;ag++){var ac=Y.childNodes[ag];var R=g(u(ac,"b:key"));var X=u(ac,"b:value");var W=B(X,"i:type");aa[R]=t(W,X)}var Q=u(S,"a:FormattedValues");for(var af=0;af<Q.childNodes.length;af++){var U=Q.childNodes[af];aa.formattedValues[g(u(U,"b:key"))]=g(u(U,"b:value"))}Z.entities.push(aa)}return Z};var D=function(T){var V,U,Q;for(var S=0;S<T.childNodes.length;S++){var R=T.childNodes[S];switch(R.nodeName){case"a:Id":V=g(R);break;case"a:LogicalName":U=g(R);break;case"a:Name":Q=g(R);break}}return{Id:V,LogicalName:U,Name:Q}};var u=function(S,T){for(var R=0;R<S.childNodes.length;R++){var Q=S.childNodes[R];if(Q.nodeName==T){return Q}}};var b=function(Q){try{var T=Q.firstChild.firstChild;var S=u(T,"s:Fault");var R=u(S,"faultstring");return new Error(g(R))}catch(U){return new Error("An error occurred when parsing the error returned from CRM server: "+U.message)}};var f=function(U,Q,S){try{var R=U.firstChild.firstChild.firstChild.firstChild}catch(T){S(T);return}return Q(R)};var z=function(S){var Q=u(S,"a:Results");var R=u(Q.firstChild,"b:value");return n(R)};var e=function(U,R,S){if((U.status>=200&&U.status<300)||U.status===304||U.status===1223){try{var Q=(!!U.responseText)?JSON.parse(U.responseText,v).d:null}catch(T){S(T);return}return R(Q)}else{S(M(U))}};var H=function(U,Q,R){var T=new XMLHttpRequest();T.open(U.type,U.url,U.async);T.setRequestHeader("Accept","application/json");T.setRequestHeader("Content-Type","application/json; charset=utf-8");if(!!U.method){T.setRequestHeader("X-HTTP-Method",U.method)}if(U.async){T.onreadystatechange=function(){if(T.readyState==4){e(T,Q,R)}};if(!!U.data){T.send(U.data)}else{T.send()}}else{try{if(!!U.data){T.send(U.data)}else{T.send()}return e(T,Q,R)}catch(S){R(S)}}};var l=function(X,U,S,T){var W=new XMLHttpRequest();W.open("POST",q+j,U);W.setRequestHeader("Accept","application/xml, text/xml, */*");W.setRequestHeader("Content-Type","text/xml; charset=utf-8");W.setRequestHeader("SOAPAction","http://schemas.microsoft.com/xrm/2011/Contracts/Services/IOrganizationService/Execute");var R=['<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>',X,"</s:Body></s:Envelope>"].join("");if(U){W.onreadystatechange=function(){if(W.readyState==4){if(W.status==200){f(W.responseXML,S,T)}else{T(a(W))}}};W.send(R)}else{try{W.send(R);if(W.status==200){return f(W.responseXML,S,T)}else{var Q=b(W.responseXML);T(Q);return}}catch(V){T(V);return}}};var G=function(R){if(!K(R.executeXml)){throw new Error("executeXml parameter was not provided. ")}var Q=!!R.async;return l(R.executeXml,Q,function(S){if(p(R.successCallback)){R.successCallback(S)}return S},function(S){if(p(R.errorCallback)){R.errorCallback(S)}else{throw S}})};var L=function(S){if(!K(S.id)){throw new Error("id parameter was not provided. ")}if(!K(S.entityName)){throw new Error("entityName parameter was not provided. ")}if(!o(S.stateCode)){throw new Error("stateCode parameter must be an integer. ")}if(S.statusCode==null){S.statusCode=-1}var R=['<Execute xmlns="http://schemas.microsoft.com/xrm/2011/Contracts/Services">','<request i:type="b:SetStateRequest"',' xmlns:a="http://schemas.microsoft.com/xrm/2011/Contracts" ',' xmlns:b="http://schemas.microsoft.com/crm/2011/Contracts" ',' xmlns:c="http://schemas.datacontract.org/2004/07/System.Collections.Generic" ',' xmlns:i="http://www.w3.org/2001/XMLSchema-instance">',"<a:Parameters>","<a:KeyValuePairOfstringanyType>","<c:key>EntityMoniker</c:key>",'<c:value i:type="a:EntityReference">',"<a:Id>",S.id,"</a:Id>","<a:LogicalName>",S.entityName,"</a:LogicalName>",'<a:Name i:nil="true" />',"</c:value>","</a:KeyValuePairOfstringanyType>","<a:KeyValuePairOfstringanyType>","<c:key>State</c:key>",'<c:value i:type="a:OptionSetValue">',"<a:Value>",S.stateCode,"</a:Value>","</c:value>","</a:KeyValuePairOfstringanyType>","<a:KeyValuePairOfstringanyType>","<c:key>Status</c:key>",'<c:value i:type="a:OptionSetValue">',"<a:Value>",S.statusCode,"</a:Value>","</c:value>","</a:KeyValuePairOfstringanyType>","</a:Parameters>",'<a:RequestId i:nil="true"/>',"<a:RequestName>SetState</a:RequestName>","</request>","</Execute>"].join("");var Q=!!S.async;return l(R,Q,function(T){if(p(S.successCallback)){S.successCallback(T)}return T},function(T){if(p(S.errorCallback)){S.errorCallback(T)}else{throw T}})};var E=function(S){if(!K(S.fetchXml)){throw new Error("fetchXml parameter was not provided. ")}var R=['<Execute xmlns="http://schemas.microsoft.com/xrm/2011/Contracts/Services">','<request i:type="a:RetrieveMultipleRequest"',' xmlns:a="http://schemas.microsoft.com/xrm/2011/Contracts" ',' xmlns:i="http://www.w3.org/2001/XMLSchema-instance">','<a:Parameters xmlns:c="http://schemas.datacontract.org/2004/07/System.Collections.Generic">',"<a:KeyValuePairOfstringanyType>","<c:key>Query</c:key>",'<c:value i:type="a:FetchExpression">',"<a:Query>",y(S.fetchXml),"</a:Query>","</c:value>","</a:KeyValuePairOfstringanyType>","</a:Parameters>",'<a:RequestId i:nil="true"/>',"<a:RequestName>RetrieveMultiple</a:RequestName>","</request>","</Execute>"].join("");var Q=!!S.async;return l(R,Q,function(T){var U=z(T);if(p(S.successCallback)){S.successCallback(U)}if(!Q){return U}},function(T){if(p(S.errorCallback)){S.errorCallback(T)}else{throw T}})};var C=function(U){if(!K(U.entityName)){throw new Error("entityName parameter was not provided. ")}if(!K(U.id)){throw new Error("id parameter was not provided. ")}var R=U.select==null?"":c(U.select,"select");var S=U.expand==null?"":c(U.expand,"expand");var Q="";if(R.length>0||S.length>0){Q="?";if(R.length>0){Q+="$select="+R;if(S.length>0){Q+="&"}}if(S.length>0){Q+="$expand="+S}}var T={url:q+s+"/"+U.entityName+"Set(guid'"+U.id+"')"+Q,type:"GET",async:!!U.async};return H(T,function(V){if(p(U.successCallback)){U.successCallback(V)}return V},function(V){if(p(U.errorCallback)){U.errorCallback(V)}else{throw V}})};var h=function(T){if(!K(T.entityName)){throw new Error("entityName parameter was not provided. ")}var Q="";if(T.odataQuery!=null){if(!k(T.odataQuery)){throw new Error("odataQuery parameter must be a string. ")}Q=T.odataQuery.charAt(0)=="?"?T.odataQuery:"?"+T.odataQuery}var S={url:q+s+"/"+T.entityName+"Set"+Q,type:"GET",async:!!T.async};var U=[];var R=false;while(!R){H(S,function(V){U=U.concat(V.results);if(p(T.successCallback)){T.successCallback(V.results)}if(V.__next!=null){var W=s+"/"+T.entityName+"Set";Q=V.__next.slice(V.__next.indexOf(W)+W.length);S.url=q+s+"/"+T.entityName+"Set"+Q}else{if(p(T.completionCallback)){T.completionCallback()}R=true}},function(V){if(p(T.errorCallback)){T.errorCallback(V)}else{throw V}})}return U};var N=function(R){if(!K(R.entityName)){throw new Error("entityName parameter was not provided. ")}if(R.entity===null||R.entity===m){throw new Error("entity parameter was not provided. ")}var Q={url:q+s+"/"+R.entityName+"Set",type:"POST",data:J.JSON.stringify(R.entity),async:!!R.async};return H(Q,function(S){if(p(R.successCallback)){R.successCallback(S)}return S},function(S){if(p(R.errorCallback)){R.errorCallback(S)}else{throw S}})};var A=function(R){if(!K(R.entityName)){throw new Error("entityName parameter was not provided. ")}if(!K(R.id)){throw new Error("id parameter was not provided. ")}if(R.entity===null||R.entity===m){throw new Error("entity parameter was not provided. ")}var Q={url:q+s+"/"+R.entityName+"Set(guid'"+R.id+"')",type:"POST",method:"MERGE",data:J.JSON.stringify(R.entity),async:!!R.async};return H(Q,function(S){if(p(R.successCallback)){R.successCallback(S)}return S},function(S){if(p(R.errorCallback)){R.errorCallback(S)}else{throw S}})};var O=function(R){if(!K(R.entityName)){throw new Error("entityName parameter was not provided. ")}if(!K(R.id)){throw new Error("id parameter was not provided. ")}var Q={url:q+s+"/"+R.entityName+"Set(guid'"+R.id+"')",type:"POST",method:"DELETE",async:!!R.async};return H(Q,function(S){if(p(R.successCallback)){R.successCallback(S)}return S},function(S){if(p(R.errorCallback)){R.errorCallback(S)}else{throw S}})};var I=function(R){if(!K(R.entity1Id)){throw new Error("entity1Id parameter was not provided. ")}if(!K(R.entity1Name)){throw new Error("entity1Name parameter was not provided. ")}if(!K(R.entity2Id)){throw new Error("entity2Id parameter was not provided. ")}if(!K(R.entity2Name)){throw new Error("entity2Name parameter was not provided. ")}if(!K(R.relationshipName)){throw new Error("relationshipName parameter was not provided. ")}var S={uri:q+s+"/"+R.entity2Name+"Set(guid'"+R.entity2Id+"')"};var Q={url:q+s+"/"+R.entity1Name+"Set(guid'"+R.entity1Id+"')/$links/"+R.relationshipName,type:"POST",data:J.JSON.stringify(S),async:!!R.async};return H(Q,function(T){if(p(R.successCallback)){R.successCallback(T)}return T},function(T){if(p(R.errorCallback)){R.errorCallback(T)}else{throw T}})};var r=function(R){if(!K(R.entity1Id)){throw new Error("entity1Id parameter was not provided. ")}if(!K(R.entity1Name)){throw new Error("entity1Name parameter was not provided. ")}if(!K(R.entity2Id)){throw new Error("entity2Id parameter was not provided. ")}if(!K(R.relationshipName)){throw new Error("relationshipName parameter was not provided. ")}var Q={url:q+s+"/"+R.entity1Name+"Set(guid'"+R.entity1Id+"')/$links/"+R.relationshipName+"(guid'"+R.entity2Id+"')",type:"POST",method:"DELETE",async:!!R.async};return H(Q,function(S){if(p(R.successCallback)){R.successCallback(S)}return S},function(S){if(p(R.errorCallback)){R.errorCallback(S)}else{throw S}})};return{context:P,serverUrl:q,retrieve:C,retrieveMultiple:h,createRecord:N,updateRecord:A,deleteRecord:O,associate:I,disassociate:r,setState:L,execute:G,fetch:E}})(window);